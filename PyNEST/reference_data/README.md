# Reference data

Here, we provide scripts to generate, analyze, and visualize reference data for the microcircuit model, which may be useful to verify alternative implementations of the model.

## Data generation

The reference data is generated by [`generate_reference_data.py`](generate_reference_data.py).

Usage:
```bash
python generate_reference_data.py --seed <RNGseed> --path <data_path>
```

The script uses the parameters defined in [`params.py`](params.py), which overwrite some of the default parameters in [../src/microcircuit](../src/microcircuit).
The random number generator seed used to create a realization of the model and the data path can be set via the (optional) command line arguments `<RNGseed>` and `<data_path>`.

## Data analysis

The analysis of the spike data documented here closely follows the strategy used in [(Dasbach et al., 2021)](https://doi.org/10.3389/fnins.2021.757790).

### Single network realization

In a first step, we compute and store the time averaged firing rates and the coefficients of variation of inter-spike intervals (ISI CVs) for each individual neuron in each population of the network (`rates.json`, `spikes_cvs.json`).
Similarly, we calculate and store the spike spike-count correlation coefficients (on a millisecond timescale) for all pairs of neurons within a smaller subset of neurons for each population  (`spikes_ccs.json`).
The script [`analyze_reference_data.py`](analyze_reference_data.py) implements this part of the data analysis.

Usage:
```bash
python analyze_reference_data.py --seed <RNGseed> --path <data_path>
```

The seed for the network realization and the data path are specified by the command line arguments `<RNGseed>` and `<data_path>`.
The parameters of the data analysis are set in [`params.py`](params.py).

### Ensemble of network realizations

The microcircuit model is a probabilistic model: both the network connectivity as well as the initial membrane potentials are randomly generated according to the rules specified in the [model documentation](https://microcircuit-PD14-model.readthedocs.io/en/latest/model_description.html).
To quantifiy the variability in the above computed spike statistics across the ensemble of network realizations, we compute the Kolmogorov–Smirnov (KS) statistics for the respective distributions (time averaged firing rates, ISI CVs and spike correlations) for each pair of network realizations (`rate_ks_distances.json`, `spike_cvs_ks_distances.json`, `spike_ccs_ks_distances.json`).
These KS scores quantify the natural variability intrinsic to the model, and are useful when verifying other implementions of the model based on the reference ("ground truth") data provided here.
For further details, see [(Dasbach et al., 2021)](https://doi.org/10.3389/fnins.2021.757790).

This second step of the analysis, the quantification of the ensemble statistis, is implemented in [compute_ensemble_stats.py](compute_ensemble_stats.py).

Usage:
```bash
python compute_ensemble_stats.py
```

The script assumes that the data is organized as described below in section "Sets of simulated and analyzed reference data".

## Data visualization

The script [plot_reference_analysis.py](plot_reference_analysis.py) visualizes the statistics extracted by [`analyze_reference_data.py`](analyze_reference_data.py) and [compute_ensemble_stats.py](compute_ensemble_stats.py), and produces the figures below.

Usage:
```bash
python plot_reference_analysis.py
```

|firing rate | spike irregularity | spike correlation |
|--|--|--|
| <img src="figures/rate_distributions_T900s.png" width="300"/> | <img src="figures/spike_cvs_distributions_T900s.png" width="300"/> | <img src="figures/spike_ccs_distributions_T900s.png" width="300"/> |

Distributions of the time averaged single-neuron firing rates (left), the coefficients of variation of the inter-spike intervals (ISI CVs; middle), and the pairwise spike correlation coefficients (right) across neurons for each neuronal population of the microcircuit model, for a simulation time $`T = 15`$min. Solid gray and dashed black curves depict results of individual network realizations and ensemble averages, respectively. Averaged Kolmogorov–Smirnov scores $`D_\text{KS}`$ quantify the variability of the respective distributions across the ensemble of network realizations.

| firing rate | spike irregularity | spike correlation |
|--|--|--|
| <img src="figures/rate_KS_distances_T900s.png" width="300"/> | <img src="figures/spike_cvs_KS_distances_T900s.png" width="300"/> | <img src="figures/spike_ccs_KS_distances_T900s.png" width="300"/> |

Distributions of Kolmogorov–Smirnov (KS) scores across pairs of network realizations for each spike statistics (firing rates, ISI CVs and spike correlations) and each neuronal population of the microcircuit model (simulation time $`T = 15`$min).
Red and blue vertical lines depict average KS scores $`D_\text{KS}`$ and standard deviations across pairs of network realizations.

## Snakemake workflow for local running

To test the analysis workflow, the [Snakefile](./Snakefile) defines a set of rules that run the complete analysis in a hierarchical manner.

Usage:
```bash
snakemake -j <num_cores>
```
The rule ```test_generate_reference_data``` generates a test data set and, upon successful completion of the simulations, creates the temporary file ```./data/data_T<sim_time_in_s>s/seed-<RNGseed>/raw.done```.
The rule ```test_analyze_reference_data``` uses this file as input to perform the single-realization analysis described in [sec. 3](#single-network-realization) for each simulation in the test dataset. When the analysis is complete, it produces the temporary file ```./data/data_T<sim_time_in_s>s/seed-<RNGseed>/analysis.done```.
This file is then used as input for the rule ```test_compute_ensemble_statistics```, which computes the ensemble statistics as described in [sec. 4](#ensemble-of-network-realizations). Upon completion, it generates ```./data/data_T<sim_time_in_s>s/seed-<RNGseed>/ensemble_statistics.done```.
Finally, the rule ```test_plot_reference_analysis``` takes this file as input and generates the plots, along with the file ```plots.done```. If plots are generated correctly, the test is marked as successful.

## Example of a cluster submission workflow

Simulations of the microcircuit model at full scale require substantial amounts of memory (see section "Memory requirements" in [../README.md](../README.md)).
Moreover, meaningful distributions of spike correlations require long observation/simulation times of ~10 minutes [(Dasbach et al., 2021)](https://doi.org/10.3389/fnins.2021.757790).
Running such simulations for many network realizations is computationally demanding.
In [cluster_submission](cluster_submission), we therefore provide scripts illustrating how to submit the above described data generation and analysis scripts for a range of RNG seeds to a compute cluster controlled by a SLURM queuing system.

Executing [`submit.sh`](cluster_submission/submit.sh) submits ten parallel jobs to the queuing system, each for a different network realization.
[`run_job.sh`](cluster_submission/run_job.sh) specifies required compute resources and executes the simulation and analysis scripts  [generate_reference_data.py](generate_reference_data.py) and [analyze_reference_data.py](analyze_reference_data.py).
It loads the bash script [`env.sh`](cluster_submission/env.sh) to ensure that all necessary modules and the python environment containing the microcircuit module (see [../README](../README.md)) are activated on the cluster.
Note that these examples are user and system specific and need to be adapted to a given environment.

## Sets of simulated and analyzed reference data

For convenience, we provide sets of simulated and ananlyzed reference data for different simulation times and network realizations (RNG seeds) at [Zenodo](TODO:AddLinkToZenodo).

The spike data is stored in text files `data_T<sim_time_in_s>s/seed-<RNGseed>/spike_recorder-<rec-id>-<thread-id>.dat` (1st column: neuron ID, 2nd column: spike time in ms).
Here, `<sim_time_in_s>` refers to the simulation time in seconds, `<RNGseed>` to the random number generator seed used to generate a specific realization of the model, `<rec-id>` to the population specific spike-recorder ID, and `<thread-id>` to the thread ID.
Each subfolder in addition contains metadata documenting the node IDs for each neuron population (`nodes.json`), the complete sets of model and simulation parameters (`sim_dict.json`, `net_dict.json`, `stim_dict.json`), as well as the results of the data analysis for each network realization (`rates.json`, `spikes_cvs.json`, `spikes_ccs.json`).
The results of the data analysis describing the statistics of the respective ensemble of network realizations (seeds) are stored in `data_T<sim_time_in_s>s` (`rates.json`, `spikes_cvs.json`, `spikes_ccs.json`, `rate_ks_distances.json`, `spike_cvs_ks_distances.json`, `spike_ccs_ks_distances.json`).
